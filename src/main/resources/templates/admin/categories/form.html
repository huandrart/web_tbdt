<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title th:text="${viewModel != null ? viewModel.pageTitle : 'Quản lý danh mục'} + ' - Cửa hàng điện tử'">Quản lý danh mục</title>

  <!-- CSRF (bắt buộc cho POST) -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-light">
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 m-0" th:text="${viewModel != null ? viewModel.pageTitle : 'Quản lý danh mục'}">Thêm danh mục mới</h1>
    <a th:href="@{/admin/categories}" class="btn btn-outline-secondary">Quay lại</a>
  </div>

  <div class="card">
    <div class="card-body">
      <form th:action="@{/admin/categories/save}"
            th:object="${categoryRequest}"
            method="post"
            enctype="multipart/form-data">

        <!-- Hidden ID field for edit mode -->
        <input type="hidden" th:field="*{id}" />
        
        <!-- CSRF token -->
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- Tên danh mục -->
        <div class="mb-3">
          <label for="name" class="form-label">Tên danh mục <span class="text-danger">*</span></label>
          <input id="name" type="text" class="form-control" th:field="*{name}" placeholder="Ví dụ: Laptop" required>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('name')}" th:errors="*{name}"></div>
        </div>

        <!-- Current Image Preview (edit mode) -->
        <div class="mb-3" th:if="${viewModel != null and viewModel.editMode and categoryRequest.currentImageUrl != null}">
          <label class="form-label">Hình ảnh hiện tại:</label>
          <div>
            <img th:src="@{${categoryRequest.currentImageUrl}}" 
                 alt="Category Image" 
                 style="max-width: 200px; max-height: 200px;" 
                 class="img-thumbnail">
          </div>
        </div>

        <!-- Mô tả -->
        <div class="mb-3">
          <label for="description" class="form-label">Mô tả</label>
          <textarea id="description" class="form-control" rows="3" th:field="*{description}" placeholder="Mô tả ngắn"></textarea>
          <div class="invalid-feedback d-block" th:if="${#fields.hasErrors('description')}" th:errors="*{description}"></div>
        </div>

        <!-- Trạng thái -->
        <div class="mb-3">
          <div class="form-check">
            <input class="form-check-input" 
                   type="checkbox" 
                   id="active" 
                   th:field="*{active}">
            <label class="form-check-label" for="active">
              Kích hoạt danh mục
            </label>
          </div>
        </div>

        <!-- Ảnh danh mục -->
        <div class="mb-3">
          <label for="imageFile" class="form-label">Ảnh danh mục</label>
          
          <!-- Hiển thị ảnh hiện tại nếu có -->
          <div th:if="${categoryRequest.currentImageUrl != null and !categoryRequest.currentImageUrl.isEmpty()}" class="mb-2">
            <label class="form-label">Ảnh hiện tại:</label>
            <div>
              <img th:src="@{${categoryRequest.currentImageUrl}}" 
                   alt="Current Category Image" 
                   style="max-width: 200px; max-height: 200px; object-fit: cover;" 
                   class="img-thumbnail">
            </div>
          </div>
          
          <input id="imageFile" name="imageFile" type="file" class="form-control" accept="image/*">
          <div class="form-text">Chọn file hình ảnh (JPG, PNG, GIF, WebP) - Tối đa 10MB</div>
        </div>

        <div class="d-flex justify-content-end gap-2">
          <a th:href="@{${viewModel != null ? viewModel.cancelUrl : '/admin/categories'}}" class="btn btn-outline-secondary">
            <i class="fas fa-times me-2"></i>Hủy
          </a>
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-save me-2"></i>
            <span th:text="${viewModel != null ? viewModel.submitButtonText : 'Lưu'}">Lưu</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Preview selected image
  document.getElementById('imageFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        // Remove existing preview if any
        const existingPreview = document.getElementById('imagePreview');
        if (existingPreview) {
          existingPreview.remove();
        }
        
        // Create preview
        const preview = document.createElement('div');
        preview.id = 'imagePreview';
        preview.className = 'mt-2';
        preview.innerHTML = `
          <label class="form-label">Xem trước:</label>
          <div>
            <img src="${e.target.result}" 
                 alt="Preview" 
                 style="max-width: 200px; max-height: 200px;" 
                 class="img-thumbnail">
          </div>
        `;
        
        // Insert preview after file input
        e.target.parentNode.insertBefore(preview, e.target.nextSibling);
      };
      reader.readAsDataURL(file);
    }
  });
</script>
</body>
</html>
